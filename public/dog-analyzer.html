<!DOCTYPE html>
<html>
  <head>
    <title>ê°•ì•„ì§€ ìŒì„± ê°ì • ë¶„ì„</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
      /* ê°„ë‹¨í•œ ìŠ¤íƒ€ì¼ë§ ì˜ˆì‹œ */
      .audio-analyzer-container {
        font-family: sans-serif;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        max-width: 500px;
        margin: 20px auto;
        background-color: #f9f9f9;
      }
      .audio-analyzer-container h3 {
        margin-top: 0;
        color: #333;
      }
      .audio-analyzer-container input[type="file"] {
        display: block;
        margin-bottom: 15px;
      }
      .audio-analyzer-container button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .audio-analyzer-container button:hover {
        background-color: #0056b3;
      }
      .audio-analyzer-container button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #analyzer-status,
      #analyzer-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      #analyzer-status {
        background-color: #e9ecef;
        color: #495057;
      }
      #analyzer-result.success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }
      #analyzer-result.error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="audio-analyzer-container">
      <h3>ê°•ì•„ì§€ ìŒì„± ê°ì • ë¶„ì„</h3>

      <div>
        <label for="audioFile">ìŒì„± íŒŒì¼ ì„ íƒ (MP3, WAV ë“±):</label>
        <input type="file" id="audioFile" name="audioFile" accept="audio/*" />
      </div>

      <div>
        <label for="userToken">ì‚¬ìš©ì í† í° ì…ë ¥:</label>
        <input
          type="text"
          id="userToken"
          name="userToken"
          value="imweb_test_dog_1"
          placeholder="ì˜ˆ: my_dog_token_123"
        />
        <small>ê° ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ê°’ì…ë‹ˆë‹¤.</small>
      </div>

      <button id="uploadButton">ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘</button>

      <div id="analyzer-status" style="display: none">ìƒíƒœ ë©”ì‹œì§€...</div>
      <div id="analyzer-result" style="display: none">ê²°ê³¼ í‘œì‹œ ì˜ì—­</div>
    </div>

    <script>
      // API ì—”ë“œí¬ì¸íŠ¸
      const API_BASE_URL = "/api/audio-analysis";

      // ìƒìˆ˜ ì •ì˜
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const SUPPORTED_AUDIO_TYPES = [
        "audio/mpeg",
        "audio/wav",
        "audio/mp3",
        "audio/x-m4a",
        "audio/mp4",
        "audio/aac",
        "audio/ogg",
        "audio/webm",
        "audio/x-wav",
        "audio/wave",
      ];

      const SUPPORTED_AUDIO_EXTENSIONS = [
        ".mp3",
        ".wav",
        ".m4a",
        ".aac",
        ".ogg",
      ];

      // jQuery ì‚¬ìš© (ì•„ì„ì›¹ì— ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆìŒ)
      $(document).ready(function () {
        const $uploadButton = $("#uploadButton");
        const $audioFile = $("#audioFile");
        const $userToken = $("#userToken");
        const $statusDiv = $("#analyzer-status");
        const $resultDiv = $("#analyzer-result");

        let selectedFile = null;

        // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function validateFile(file) {
          console.log("íŒŒì¼ ê²€ì¦ ì‹œì‘:", file);

          if (!file) {
            throw new Error("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          }

          console.log("íŒŒì¼ íƒ€ì…:", file.type);

          // íŒŒì¼ í™•ì¥ì í™•ì¸
          const fileName = file.name.toLowerCase();
          const fileExtension = fileName.substring(fileName.lastIndexOf("."));
          console.log("íŒŒì¼ í™•ì¥ì:", fileExtension);

          // MIME íƒ€ì… ë˜ëŠ” í™•ì¥ìë¡œ ê²€ì‚¬
          const isValidType =
            SUPPORTED_AUDIO_TYPES.includes(file.type) ||
            SUPPORTED_AUDIO_EXTENSIONS.some((ext) => fileName.endsWith(ext));

          if (!isValidType) {
            throw new Error(
              `ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ì§€ì›ë˜ëŠ” í˜•ì‹: MP3, WAV, M4A, AAC, OGG`
            );
          }

          if (file.size > MAX_FILE_SIZE) {
            throw new Error(
              `íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${
                MAX_FILE_SIZE / (1024 * 1024)
              }MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
            );
          }

          console.log("íŒŒì¼ ê²€ì¦ ì„±ê³µ");
          return true;
        }

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        $audioFile.on("change", function (event) {
          try {
            console.log("íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë°œìƒ", event.target.files);

            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ˆê¸°í™”
            if (!event.target.files || event.target.files.length === 0) {
              console.log("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ");
              selectedFile = null;
              hideStatus();
              return;
            }

            const file = event.target.files[0];
            console.log("ì„ íƒëœ íŒŒì¼:", file);

            if (file) {
              // íŒŒì¼ í¬ê¸°ì™€ í™•ì¥ì ë¨¼ì € í™•ì¸ - ë¸Œë¼ìš°ì €ì—ì„œ MIME íƒ€ì…ì„ ì˜¬ë°”ë¥´ê²Œ ë³´ê³ í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
              if (file.size > MAX_FILE_SIZE) {
                throw new Error(
                  `íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${
                    MAX_FILE_SIZE / (1024 * 1024)
                  }MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
                );
              }

              const fileName = file.name.toLowerCase();
              const fileExtension = fileName.substring(
                fileName.lastIndexOf(".")
              );

              // í™•ì¥ìë¡œ í™•ì¸
              if (
                !SUPPORTED_AUDIO_EXTENSIONS.some((ext) =>
                  fileName.endsWith(ext)
                )
              ) {
                throw new Error(
                  `ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ì§€ì›ë˜ëŠ” í˜•ì‹: MP3, WAV, M4A, AAC, OGG`
                );
              }

              // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼
              selectedFile = file;
              showStatus(
                `ì„ íƒëœ íŒŒì¼: ${file.name} (${(
                  file.size /
                  (1024 * 1024)
                ).toFixed(2)}MB)`,
                false
              );
              hideResult();
            } else {
              selectedFile = null;
              hideStatus();
            }
          } catch (error) {
            console.error("íŒŒì¼ ì„ íƒ ì˜¤ë¥˜:", error);
            selectedFile = null;
            showResult(error.message, false);
            event.target.value = ""; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
          }
        });

        // í† í° ìœ íš¨ì„± ê²€ì‚¬
        function validateToken(token) {
          if (!token || token.trim().length === 0) {
            throw new Error("ì‚¬ìš©ì í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
          return true;
        }

        // API ìš”ì²­ í•¨ìˆ˜
        async function uploadAndAnalyze(file, token) {
          const formData = new FormData();
          formData.append("audio_file", file);
          formData.append("user_token", token);

          const response = await $.ajax({
            url: API_BASE_URL,
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",
            timeout: 15000,
          });

          if (!response.success || !response.jobId) {
            throw new Error(
              response.message || "ì„œë²„ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            );
          }

          return response.jobId;
        }

        // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        $uploadButton.on("click", async function () {
          try {
            console.log("ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­, ì„ íƒëœ íŒŒì¼:", selectedFile);

            // íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¦‰ì‹œ ì—ëŸ¬ í‘œì‹œ
            if (!selectedFile) {
              throw new Error(
                "íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì˜¤ë””ì˜¤ íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”."
              );
            }

            const token = $userToken.val().trim();

            // í† í° ê²€ì¦
            validateToken(token);

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            hideResult();
            showStatus("íŒŒì¼ ì—…ë¡œë“œ ë° ë¶„ì„ ìš”ì²­ ì¤‘...", true);
            $uploadButton.prop("disabled", true);

            // API ìš”ì²­
            const jobId = await uploadAndAnalyze(selectedFile, token);

            showStatus(
              `ìš”ì²­ ì„±ê³µ! Job ID: ${jobId.substring(
                0,
                10
              )}... ë¶„ì„ ê²°ê³¼ í™•ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤.`,
              true
            );

            // í´ë§ ì‹œì‘
            await pollForResult(jobId, token);
          } catch (error) {
            console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
            hideStatus();
            showResult(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, false);
          } finally {
            $uploadButton.prop("disabled", false);
          }
        });

        function showStatus(message, isLoading = false) {
          $statusDiv.text(message);
          if (isLoading) {
            $statusDiv.append(' <div class="loader"></div>');
          }
          $statusDiv.show();
        }

        function hideStatus() {
          $statusDiv.hide().empty();
        }

        function showResult(message, isSuccess = true) {
          $resultDiv.text(message);
          $resultDiv
            .removeClass("success error")
            .addClass(isSuccess ? "success" : "error");
          $resultDiv.show();
        }

        function hideResult() {
          $resultDiv.hide().empty();
        }

        function getEmotionText(ansDogCode) {
          const emotionMap = {
            dog_1: "ì—ë„ˆìì´ì € \uD83D\uDC36âš¡", // ğŸ¶âš¡
            dog_2: "ìš”êµ¬ ì¤‘ \uD83D\uDE4B", // ğŸ™‹
            dog_3: "í™”ë‚¨ \uD83D\uDE21", // ğŸ˜¡
            dog_4: "ë°©ì–´ì  \uD83D\uDEE1ï¸", // ğŸ›¡ï¸
            dog_5: "ì£¼ëª©! \uD83D\uDC40", // ğŸ‘€
            dog_6: "ì™¸ë¡œì›€ \uD83E\uDD7A", // ğŸ¥º
            dog_7: "ìˆ˜ë‹¤ìŸì´ \uD83D\uDDE3ï¸", // ğŸ—£ï¸
            dog_8: "ì•„í”” \uD83E\uDD15", // ğŸ¤•
          };
          return emotionMap[ansDogCode] || ansDogCode || "ì•Œ ìˆ˜ ì—†ëŠ” ê°ì • ì½”ë“œ";
        }

        async function pollForResult(
          jobId,
          userToken,
          maxRetries = 30,
          interval = 2500
        ) {
          // í´ë§ íšŸìˆ˜ ë° ê°„ê²© ì¦ê°€
          showStatus(
            `ë¶„ì„ ê²°ê³¼ í™•ì¸ ì¤‘... (Job ID: ${jobId.substring(0, 10)}...)`,
            true
          );
          const pollUrl = `${API_BASE_URL}?jobId=${encodeURIComponent(
            jobId
          )}&userToken=${encodeURIComponent(userToken)}`;

          for (let i = 0; i < maxRetries; i++) {
            try {
              const response = await $.ajax({
                // jQuery AJAX ì‚¬ìš©
                url: pollUrl,
                method: "GET",
                dataType: "json", // ì„œë²„ê°€ JSONì„ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
                timeout: 10000, // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
              });

              // ì„±ê³µì ìœ¼ë¡œ ì‘ë‹µì„ ë°›ì•˜ìœ¼ë‚˜, ë‚´ìš© í™•ì¸ í•„ìš”
              if (response.success && response.status === "COMPLETED") {
                hideStatus();
                const result = response.result;
                let resultMessage = `ë¶„ì„ ì™„ë£Œ!\níŒŒì¼ëª…: ${
                  result.fileNameOrigin || "N/A"
                }\n`;
                if (result.ansFilter === "noise") {
                  resultMessage +=
                    "ê²°ê³¼: ì£¼ë³€ ì†ŒìŒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì‹œë„í•´ ë³´ì„¸ìš”.";
                } else if (result.ansDog) {
                  resultMessage += `ê°ì •: ${getEmotionText(result.ansDog)}`;
                } else {
                  resultMessage += "ê²°ê³¼: ê°ì •ì„ íŠ¹ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }
                showResult(resultMessage, true);
                return; // í´ë§ ì¢…ë£Œ
              } else if (response.success && response.status === "PROCESSING") {
                showStatus(
                  `ë¶„ì„ ì§„í–‰ ì¤‘... (${i + 1}/${maxRetries}) ë‹¤ìŒ í™•ì¸ê¹Œì§€ ${
                    interval / 1000
                  }ì´ˆ`,
                  true
                );
              } else if (response.success && response.status === "NO_CONTENT") {
                hideStatus();
                showResult(
                  `ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Job ID: ${jobId})`,
                  false
                );
                return;
              } else {
                // success: false ë˜ëŠ” ì˜ˆìƒì¹˜ ëª»í•œ status
                showStatus(
                  `ê²°ê³¼ í™•ì¸ ì¤‘ ì‘ë‹µ ì˜¤ë¥˜ (${i + 1}/${maxRetries}): ${
                    response.message || "ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ"
                  }`,
                  true
                );
              }
            } catch (jqXHR) {
              // AJAX ì—ëŸ¬ ì²˜ë¦¬
              let errorMsg = `ê²°ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ì‹œë„ ${
                i + 1
              }/${maxRetries}).`;
              if (jqXHR.statusText === "timeout") {
                errorMsg += " ì„œë²„ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼.";
              } else if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                errorMsg += ` ì„œë²„ ë©”ì‹œì§€: ${jqXHR.responseJSON.error}`;
              } else if (jqXHR.responseText) {
                errorMsg += ` ì„œë²„ ì‘ë‹µ: ${jqXHR.responseText.substring(
                  0,
                  100
                )}`;
              }
              showStatus(errorMsg, true); // ë¡œë” ìœ ì§€í•˜ë©° ë‹¤ìŒ ì‹œë„
            }

            if (i < maxRetries - 1) {
              await new Promise((resolve) => setTimeout(resolve, interval));
            }
          }
          hideStatus();
          showResult(
            `ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${maxRetries}íšŒ)`,
            false
          );
        }
      });
    </script>
  </body>
</html>
