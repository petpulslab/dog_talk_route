<!DOCTYPE html>
<html>
  <head>
    <title>강아지 음성 감정 분석</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
      /* 간단한 스타일링 예시 */
      .audio-analyzer-container {
        font-family: sans-serif;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        max-width: 500px;
        margin: 20px auto;
        background-color: #f9f9f9;
      }
      .audio-analyzer-container h3 {
        margin-top: 0;
        color: #333;
      }
      .audio-analyzer-container input[type="file"] {
        display: block;
        margin-bottom: 15px;
      }
      .audio-analyzer-container button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .audio-analyzer-container button:hover {
        background-color: #0056b3;
      }
      .audio-analyzer-container button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #analyzer-status,
      #analyzer-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      #analyzer-status {
        background-color: #e9ecef;
        color: #495057;
      }
      #analyzer-result.success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
      }
      #analyzer-result.error {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="audio-analyzer-container">
      <h3>강아지 음성 감정 분석</h3>

      <div>
        <label for="audioFile">음성 파일 선택 (MP3, WAV 등):</label>
        <input type="file" id="audioFile" name="audioFile" accept="audio/*" />
      </div>

      <div>
        <label for="userToken">사용자 토큰 입력:</label>
        <input
          type="text"
          id="userToken"
          name="userToken"
          value="imweb_test_dog_1"
          placeholder="예: my_dog_token_123"
        />
        <small>각 사용자를 구분하기 위한 값입니다.</small>
      </div>

      <button id="uploadButton">업로드 및 분석 시작</button>

      <div id="analyzer-status" style="display: none">상태 메시지...</div>
      <div id="analyzer-result" style="display: none">결과 표시 영역</div>
    </div>

    <script>
      // API 엔드포인트
      const API_BASE_URL = "/api/audio-analysis";

      // 상수 정의
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const SUPPORTED_AUDIO_TYPES = [
        "audio/mpeg",
        "audio/wav",
        "audio/mp3",
        "audio/x-m4a",
        "audio/mp4",
        "audio/aac",
        "audio/ogg",
        "audio/webm",
        "audio/x-wav",
        "audio/wave",
      ];

      const SUPPORTED_AUDIO_EXTENSIONS = [
        ".mp3",
        ".wav",
        ".m4a",
        ".aac",
        ".ogg",
      ];

      // jQuery 사용 (아임웹에 이미 로드되어 있음)
      $(document).ready(function () {
        const $uploadButton = $("#uploadButton");
        const $audioFile = $("#audioFile");
        const $userToken = $("#userToken");
        const $statusDiv = $("#analyzer-status");
        const $resultDiv = $("#analyzer-result");

        let selectedFile = null;

        // 파일 유효성 검사 함수
        function validateFile(file) {
          console.log("파일 검증 시작:", file);

          if (!file) {
            throw new Error("파일이 선택되지 않았습니다.");
          }

          console.log("파일 타입:", file.type);

          // 파일 확장자 확인
          const fileName = file.name.toLowerCase();
          const fileExtension = fileName.substring(fileName.lastIndexOf("."));
          console.log("파일 확장자:", fileExtension);

          // MIME 타입 또는 확장자로 검사
          const isValidType =
            SUPPORTED_AUDIO_TYPES.includes(file.type) ||
            SUPPORTED_AUDIO_EXTENSIONS.some((ext) => fileName.endsWith(ext));

          if (!isValidType) {
            throw new Error(
              `지원되지 않는 파일 형식입니다. 지원되는 형식: MP3, WAV, M4A, AAC, OGG`
            );
          }

          if (file.size > MAX_FILE_SIZE) {
            throw new Error(
              `파일 크기가 너무 큽니다. 최대 ${
                MAX_FILE_SIZE / (1024 * 1024)
              }MB까지 업로드 가능합니다.`
            );
          }

          console.log("파일 검증 성공");
          return true;
        }

        // 파일 선택 이벤트 핸들러
        $audioFile.on("change", function (event) {
          try {
            console.log("파일 선택 이벤트 발생", event.target.files);

            // 파일이 선택되지 않았다면 초기화
            if (!event.target.files || event.target.files.length === 0) {
              console.log("파일이 선택되지 않음");
              selectedFile = null;
              hideStatus();
              return;
            }

            const file = event.target.files[0];
            console.log("선택된 파일:", file);

            if (file) {
              // 파일 크기와 확장자 먼저 확인 - 브라우저에서 MIME 타입을 올바르게 보고하지 않을 수 있음
              if (file.size > MAX_FILE_SIZE) {
                throw new Error(
                  `파일 크기가 너무 큽니다. 최대 ${
                    MAX_FILE_SIZE / (1024 * 1024)
                  }MB까지 업로드 가능합니다.`
                );
              }

              const fileName = file.name.toLowerCase();
              const fileExtension = fileName.substring(
                fileName.lastIndexOf(".")
              );

              // 확장자로 확인
              if (
                !SUPPORTED_AUDIO_EXTENSIONS.some((ext) =>
                  fileName.endsWith(ext)
                )
              ) {
                throw new Error(
                  `지원되지 않는 파일 형식입니다. 지원되는 형식: MP3, WAV, M4A, AAC, OGG`
                );
              }

              // 파일 유효성 검사 통과
              selectedFile = file;
              showStatus(
                `선택된 파일: ${file.name} (${(
                  file.size /
                  (1024 * 1024)
                ).toFixed(2)}MB)`,
                false
              );
              hideResult();
            } else {
              selectedFile = null;
              hideStatus();
            }
          } catch (error) {
            console.error("파일 선택 오류:", error);
            selectedFile = null;
            showResult(error.message, false);
            event.target.value = ""; // 파일 선택 초기화
          }
        });

        // 토큰 유효성 검사
        function validateToken(token) {
          if (!token || token.trim().length === 0) {
            throw new Error("사용자 토큰을 입력해주세요.");
          }
          return true;
        }

        // API 요청 함수
        async function uploadAndAnalyze(file, token) {
          const formData = new FormData();
          formData.append("audio_file", file);
          formData.append("user_token", token);

          const response = await $.ajax({
            url: API_BASE_URL,
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            dataType: "json",
            timeout: 15000,
          });

          if (!response.success || !response.jobId) {
            throw new Error(
              response.message || "서버에서 작업을 시작하지 못했습니다."
            );
          }

          return response.jobId;
        }

        // 업로드 버튼 클릭 이벤트 핸들러
        $uploadButton.on("click", async function () {
          try {
            console.log("업로드 버튼 클릭, 선택된 파일:", selectedFile);

            // 파일이 선택되지 않았으면 즉시 에러 표시
            if (!selectedFile) {
              throw new Error(
                "파일이 선택되지 않았습니다. 오디오 파일을 먼저 선택해주세요."
              );
            }

            const token = $userToken.val().trim();

            // 토큰 검증
            validateToken(token);

            // UI 상태 업데이트
            hideResult();
            showStatus("파일 업로드 및 분석 요청 중...", true);
            $uploadButton.prop("disabled", true);

            // API 요청
            const jobId = await uploadAndAnalyze(selectedFile, token);

            showStatus(
              `요청 성공! Job ID: ${jobId.substring(
                0,
                10
              )}... 분석 결과 확인을 시작합니다.`,
              true
            );

            // 폴링 시작
            await pollForResult(jobId, token);
          } catch (error) {
            console.error("오류 발생:", error);
            hideStatus();
            showResult(`오류 발생: ${error.message}`, false);
          } finally {
            $uploadButton.prop("disabled", false);
          }
        });

        function showStatus(message, isLoading = false) {
          $statusDiv.text(message);
          if (isLoading) {
            $statusDiv.append(' <div class="loader"></div>');
          }
          $statusDiv.show();
        }

        function hideStatus() {
          $statusDiv.hide().empty();
        }

        function showResult(message, isSuccess = true) {
          $resultDiv.text(message);
          $resultDiv
            .removeClass("success error")
            .addClass(isSuccess ? "success" : "error");
          $resultDiv.show();
        }

        function hideResult() {
          $resultDiv.hide().empty();
        }

        function getEmotionText(ansDogCode) {
          const emotionMap = {
            dog_1: "에너자이저 \uD83D\uDC36⚡", // 🐶⚡
            dog_2: "요구 중 \uD83D\uDE4B", // 🙋
            dog_3: "화남 \uD83D\uDE21", // 😡
            dog_4: "방어적 \uD83D\uDEE1️", // 🛡️
            dog_5: "주목! \uD83D\uDC40", // 👀
            dog_6: "외로움 \uD83E\uDD7A", // 🥺
            dog_7: "수다쟁이 \uD83D\uDDE3️", // 🗣️
            dog_8: "아픔 \uD83E\uDD15", // 🤕
          };
          return emotionMap[ansDogCode] || ansDogCode || "알 수 없는 감정 코드";
        }

        async function pollForResult(
          jobId,
          userToken,
          maxRetries = 30,
          interval = 2500
        ) {
          // 폴링 횟수 및 간격 증가
          showStatus(
            `분석 결과 확인 중... (Job ID: ${jobId.substring(0, 10)}...)`,
            true
          );
          const pollUrl = `${API_BASE_URL}?jobId=${encodeURIComponent(
            jobId
          )}&userToken=${encodeURIComponent(userToken)}`;

          for (let i = 0; i < maxRetries; i++) {
            try {
              const response = await $.ajax({
                // jQuery AJAX 사용
                url: pollUrl,
                method: "GET",
                dataType: "json", // 서버가 JSON을 반환한다고 가정
                timeout: 10000, // 10초 타임아웃
              });

              // 성공적으로 응답을 받았으나, 내용 확인 필요
              if (response.success && response.status === "COMPLETED") {
                hideStatus();
                const result = response.result;
                let resultMessage = `분석 완료!\n파일명: ${
                  result.fileNameOrigin || "N/A"
                }\n`;
                if (result.ansFilter === "noise") {
                  resultMessage +=
                    "결과: 주변 소음이 감지되었습니다. 다른 파일을 시도해 보세요.";
                } else if (result.ansDog) {
                  resultMessage += `감정: ${getEmotionText(result.ansDog)}`;
                } else {
                  resultMessage += "결과: 감정을 특정할 수 없습니다.";
                }
                showResult(resultMessage, true);
                return; // 폴링 종료
              } else if (response.success && response.status === "PROCESSING") {
                showStatus(
                  `분석 진행 중... (${i + 1}/${maxRetries}) 다음 확인까지 ${
                    interval / 1000
                  }초`,
                  true
                );
              } else if (response.success && response.status === "NO_CONTENT") {
                hideStatus();
                showResult(
                  `분석 결과를 찾을 수 없습니다. (Job ID: ${jobId})`,
                  false
                );
                return;
              } else {
                // success: false 또는 예상치 못한 status
                showStatus(
                  `결과 확인 중 응답 오류 (${i + 1}/${maxRetries}): ${
                    response.message || "알 수 없는 상태"
                  }`,
                  true
                );
              }
            } catch (jqXHR) {
              // AJAX 에러 처리
              let errorMsg = `결과 조회 중 오류 발생 (시도 ${
                i + 1
              }/${maxRetries}).`;
              if (jqXHR.statusText === "timeout") {
                errorMsg += " 서버 응답 시간 초과.";
              } else if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                errorMsg += ` 서버 메시지: ${jqXHR.responseJSON.error}`;
              } else if (jqXHR.responseText) {
                errorMsg += ` 서버 응답: ${jqXHR.responseText.substring(
                  0,
                  100
                )}`;
              }
              showStatus(errorMsg, true); // 로더 유지하며 다음 시도
            }

            if (i < maxRetries - 1) {
              await new Promise((resolve) => setTimeout(resolve, interval));
            }
          }
          hideStatus();
          showResult(
            `분석 결과를 가져오는데 실패했습니다. (시도 횟수 초과: ${maxRetries}회)`,
            false
          );
        }
      });
    </script>
  </body>
</html>
